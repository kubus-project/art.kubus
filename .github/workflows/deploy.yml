name: Deploy (manual)

on:
  workflow_dispatch:
    inputs:
      deploy_web:
        description: 'Deploy Flutter web build to app server via FTP'
        required: false
        default: true
        type: boolean
      build_apk:
        description: 'Build Android APK (debug-signed release mode)'
        required: false
        default: true
        type: boolean
      publish_github_release:
        description: 'Create/Update a GitHub Release and upload the APK'
        required: false
        default: true
        type: boolean
      release_tag:
        description: 'Release tag to create/use (leave empty to auto-generate)'
        required: false
        default: ''
        type: string
      prerelease:
        description: 'Mark GitHub Release as a prerelease'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy_web:
    name: FTP deploy (Flutter web)
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_web }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Check FTP secrets
        id: ftp
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          if [ -n "$FTP_SERVER" ] && [ -n "$FTP_USERNAME" ] && [ -n "$FTP_PASSWORD" ]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Flutter
        if: ${{ steps.ftp.outputs.ok == 'true' }}
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Prepare Dart defines (optional)
        id: defines
        if: ${{ steps.ftp.outputs.ok == 'true' }}
        shell: bash
        env:
          KUBUS_BACKEND_URL: ${{ secrets.KUBUS_BACKEND_URL }}
          KUBUS_WALLETCONNECT_PROJECT_ID: ${{ secrets.KUBUS_WALLETCONNECT_PROJECT_ID }}
          KUBUS_PINATA_API_KEY: ${{ secrets.KUBUS_PINATA_API_KEY }}
          KUBUS_PINATA_SECRET_KEY: ${{ secrets.KUBUS_PINATA_SECRET_KEY }}
        run: |
          ARGS=""
          add() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              ARGS="$ARGS --dart-define=${name}=${value}"
            fi
          }
          add KUBUS_BACKEND_URL "$KUBUS_BACKEND_URL"
          add KUBUS_WALLETCONNECT_PROJECT_ID "$KUBUS_WALLETCONNECT_PROJECT_ID"
          add KUBUS_PINATA_API_KEY "$KUBUS_PINATA_API_KEY"
          add KUBUS_PINATA_SECRET_KEY "$KUBUS_PINATA_SECRET_KEY"
          echo "args=$ARGS" >> "$GITHUB_OUTPUT"

      - name: Build Flutter web
        if: ${{ steps.ftp.outputs.ok == 'true' }}
        run: |
          flutter pub get
          flutter build web --release ${{ steps.defines.outputs.args }}

      - name: FTP Deploy (Flutter Web)
        if: ${{ steps.ftp.outputs.ok == 'true' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: build/web/
          server-dir: /app.kubus.site/

      - name: Skip deploy (missing FTP secrets)
        if: ${{ steps.ftp.outputs.ok != 'true' }}
        run: |
          echo "FTP secrets not configured; skipping web deploy."

  apk:
    name: Build APK + upload to GitHub Release
    runs-on: ubuntu-latest
    if: ${{ inputs.build_apk }}
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        shell: bash
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" "platform-tools"

      - name: Accept Android licenses
        shell: bash
        run: yes | flutter doctor --android-licenses

      - name: Flutter pub get
        run: flutter pub get

      - name: Prepare Dart defines (optional)
        id: apk_defines
        shell: bash
        env:
          KUBUS_BACKEND_URL: ${{ secrets.KUBUS_BACKEND_URL }}
          KUBUS_WALLETCONNECT_PROJECT_ID: ${{ secrets.KUBUS_WALLETCONNECT_PROJECT_ID }}
          KUBUS_PINATA_API_KEY: ${{ secrets.KUBUS_PINATA_API_KEY }}
          KUBUS_PINATA_SECRET_KEY: ${{ secrets.KUBUS_PINATA_SECRET_KEY }}
        run: |
          ARGS=""
          add() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              ARGS="$ARGS --dart-define=${name}=${value}"
            fi
          }
          add KUBUS_BACKEND_URL "$KUBUS_BACKEND_URL"
          add KUBUS_WALLETCONNECT_PROJECT_ID "$KUBUS_WALLETCONNECT_PROJECT_ID"
          add KUBUS_PINATA_API_KEY "$KUBUS_PINATA_API_KEY"
          add KUBUS_PINATA_SECRET_KEY "$KUBUS_PINATA_SECRET_KEY"
          echo "args=$ARGS" >> "$GITHUB_OUTPUT"

      - name: Build APK (release mode, current project signing)
        run: flutter build apk --release ${{ steps.apk_defines.outputs.args }}

      - name: Upload APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error

      - name: Choose release tag
        id: release_tag
        if: ${{ inputs.publish_github_release }}
        shell: bash
        run: |
          TAG="${{ inputs.release_tag }}"
          if [ -z "$TAG" ]; then
            TAG="apk-${GITHUB_RUN_NUMBER}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release + upload APK
        if: ${{ inputs.publish_github_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: ${{ steps.release_tag.outputs.tag }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            build/app/outputs/flutter-apk/*.apk
